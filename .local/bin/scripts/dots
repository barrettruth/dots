#!/bin/sh

abort() {
  echo "$1" >&2
  exit 1
}

cd "$HOME/dev/dots" || abort "Cannot enter dotfiles directory: $HOME/dev/dots"
test -n "$XDG_CONFIG_HOME" || abort "XDG_CONFIG_HOME not set"

ensure_dir() {
  test -d "$1" || mkdir -p "$1" || abort "Failed to create directory $1"
}

copy_pkg_lists() {
  ensure_dir pkgs
  command -v pacman >/dev/null 2>&1 && pacman -Qen > pkgs/pacman.txt || echo "pacman not found"
  command -v pikaur >/dev/null 2>&1 && pikaur -Qm > pkgs/pikaur.txt || echo "pikaur not found"
  command -v pnpm >/dev/null 2>&1 && pnpm -g list | tail -n +6 > pkgs/pnpm.txt || echo "pnpm not found"
  command -v pip >/dev/null 2>&1 && pip list --not-required > pkgs/pip.txt || echo "pip not found"
  test -n "$GOPATH" && test -d "$GOPATH/bin" && ls "$GOPATH/bin" > pkgs/go.txt
  test -n "$CARGO_HOME" && test -d "$CARGO_HOME/bin" && ls "$CARGO_HOME/bin" > pkgs/cargo.txt
}

copy_systemd_configs() {
  ensure_dir etc/systemd/system
  cp /etc/systemd/system/*.service etc/systemd/system
  cp /etc/systemd/system/*.timer etc/systemd/system

  ensure_dir .config/systemd
  cp -r "$XDG_CONFIG_HOME"/systemd .config
}

copy_nix_configs() {
  ensure_dir etc/nix
  test -d /etc/nix && cp -f /etc/nix/* etc/nix
}

copy_xdg_configs() {
  test -n "$XDG_CONFIG_HOME" || abort "XDG_CONFIG_HOME not set"

  dest="${XDG_CONFIG_HOME#"$HOME"/}"
  ensure_dir "$dest"

  for folder in lf git npm nvim python rg tmux yamllint zsh mutt dunst ghostty fzf task rofi sway spectrwm X11 waybar hypr; do
    test -d "$XDG_CONFIG_HOME/$folder" || continue
    test -d "$dest/$folder" && rm -rf "${dest:?}/$folder"
    cp -rf "$XDG_CONFIG_HOME/$folder" "$dest/$folder" || echo "Failed to copy $folder"
  done

  test -f "$XDG_CONFIG_HOME"/claude/CLAUDE.md && mkdir -p "$dest/claude" && cp -f "$XDG_CONFIG_HOME"/claude/CLAUDE.md "$dest/claude"

  test -d "$dest/zsh/pure" && rm -rf "$dest/zsh/pure"
  test -f "$dest/zsh/.zcompdump" && rm -f "$dest/zsh/.zcompdump"
  rm -rf "$dest/tmux/plugins"

  test -d "$XDG_CONFIG_HOME/luarocks" && ensure_dir "$dest/luarocks" && cp "$XDG_CONFIG_HOME/luarocks/"* "$dest/luarocks" 2>/dev/null
  test -f "$HOME/.zshenv" && cp -f "$HOME/.zshenv" "$dest/zsh"

  test -f "$XDG_CONFIG_HOME"/mimeapps.list && cp -f "$XDG_CONFIG_HOME"/mimeapps.list .config

  test -n "$SCRIPTS" || abort "SCRIPTS not set"
  dest="${SCRIPTS#"$HOME"/}"
  test -d "$SCRIPTS" && ensure_dir "$SCRIPTS" && cp -f "$SCRIPTS"/* "$dest" 2>/dev/null
}

copy_etc_configs() {
  ensure_dir etc/default
  ensure_dir etc/keyd
  ensure_dir etc/pacman.d/hooks
  ensure_dir etc/X11/xorg.conf.d
  ensure_dir etc/xdg/reflector

  test -f /etc/default/grub && cp -f /etc/default/grub etc/default/grub || echo "Missing /etc/default/grub"
  test -f /etc/doas.conf && cp -f /etc/doas.conf etc/doas.conf || echo "Missing /etc/doas.conf"
  test -d /etc/keyd && cp -f /etc/keyd/* etc/keyd 2>/dev/null || echo "Missing /etc/keyd"
  test -f /etc/pacman.conf && cp -f /etc/pacman.conf etc/pacman.conf || echo "Missing /etc/pacman.conf"
  test -d /etc/pacman.d/hooks && cp -rf /etc/pacman.d/hooks/* etc/pacman.d/hooks 2>/dev/null || echo "Missing pacman hooks"
  test -d /etc/X11/xorg.conf.d && cp -rf /etc/X11/xorg.conf.d/* etc/X11/xorg.conf.d 2>/dev/null || echo "Missing X11 configs"
  test -f /etc/xdg/reflector/reflector.conf && cp /etc/xdg/reflector/reflector.conf etc/xdg/reflector/reflector.conf || echo "Missing reflector.conf"

  test -n "$XDG_DATA_HOME/applications" || abort "XDG_DATA_HOME not set"
  dest="${XDG_DATA_HOME#"$HOME"/}/applications"
  test -d "$XDG_DATA_HOME"/applications && ensure_dir "$dest" && cp "$XDG_DATA_HOME/applications/"*.desktop "$XDG_DATA_HOME/applications/"*.list "$dest" 2>/dev/null
}

copy_pkg_lists
copy_xdg_configs
copy_etc_configs
copy_systemd_configs
copy_nix_configs
